

<!DOCTYPE html>
<html>
<head>
<style type="text/css">
.knitr.inline {
  background-color: #f7f7f7;
  border:solid 1px #B0B0B0;
}
.error {
	font-weight: bold;
	color: #FF0000;
},
.warning {
	font-weight: bold;
}
.message {
	font-style: italic;
}
.source, .output, .warning, .error, .message {
	padding: 0em 1em;
  border:solid 1px #F7F7F7;
}
.source {
  background-color: #f5f5f5;
}
.rimage.left {
  text-align: left;
}
.rimage.right {
  text-align: right;
}
.rimage.center {
  text-align: center;
}
.hl.num {
  color: #AF0F91;
}
.hl.str {
  color: #317ECC;
}
.hl.com {
  color: #AD95AF;
  font-style: italic;
}
.hl.opt {
  color: #000000;
}
.hl.std {
  color: #585858;
}
.hl.kwa {
  color: #295F94;
  font-weight: bold;
}
.hl.kwb {
  color: #B05A65;
}
.hl.kwc {
  color: #55aa55;
}
.hl.kwd {
  color: #BC5A65;
  font-weight: bold;
}
</style>
  <title>A Report Generated by knitr</title>
</head>
<body>

  <p>This report is automatically generated with the R
    package <a href="http://yihui.name/knitr"><strong>knitr</strong></a>
    (version <code class="knitr inline">1.5</code>)
    .</p>

<div class="chunk" id="unnamed-chunk-1"><div class="rcode"><div class="source"><pre class="knitr r"><span class="hl com">############################################### </span>
<span class="hl com">#' # Create get_data function!</span>

<span class="hl com"># get_data &lt;- local({ all_data &lt;- readRDS('all_data.rds') # all_data &lt;- all_data[1:100,] #</span>
<span class="hl com"># length(all_data$Date) # 4204424 unique_Date &lt;- unique(all_data$Date) n_unique_Date &lt;-</span>
<span class="hl com"># length(unique_Date) # 949918 # length(unique_Date) # 949918 # min_data &lt;-</span>
<span class="hl com"># min(all_data$Date) # max_data &lt;- max(all_data$Date) i_date &lt;- 1 function() {</span>
<span class="hl com"># require(dplyr) temp_data_2 &lt;- filter(all_data, `Date` == unique_Date[i_date]) if(i_date &gt;</span>
<span class="hl com"># n_unique_Date) {return('END OF FILE')} # if(nrow(temp_data_2) == 0) {return(NULL)} # else</span>
<span class="hl com"># i_date &lt;&lt;- i_date+1 return(temp_data_2) } })</span>

<span class="hl com"># system.time(get_data()) # around 0.3 sec for each run!  head(all_data) get_data() for(i</span>
<span class="hl com"># in 1:100) print(get_data()) get_data</span>




<span class="hl std">price_of_selling_asset</span> <span class="hl kwb">&lt;-</span> <span class="hl kwa">function</span><span class="hl std">(</span><span class="hl kwc">asset_name</span><span class="hl std">) {</span>
    <span class="hl com"># asset_name: German10 German5 TYc1 US5Y EUR_USD asset_name = 'German10'</span>
    <span class="hl com"># my_assets_enter_price()['TYc1'] my_assets_exit_price()['TYc1']</span>
    <span class="hl std">enter_price</span> <span class="hl kwb">&lt;-</span> <span class="hl kwd">as.numeric</span><span class="hl std">(</span><span class="hl kwd">my_assets_enter_price</span><span class="hl std">()[asset_name])</span>
    <span class="hl std">exit_price</span> <span class="hl kwb">&lt;-</span> <span class="hl kwd">as.numeric</span><span class="hl std">(</span><span class="hl kwd">my_assets_exit_price</span><span class="hl std">()[asset_name])</span>
    <span class="hl std">quantity</span> <span class="hl kwb">&lt;-</span> <span class="hl kwd">my_assets</span><span class="hl std">()[asset_name]</span>

    <span class="hl com"># enter_price &lt;- 10 exit_price &lt;- 12 quantity &lt;- 1 quantity &lt;- -1 enter_price &lt;- 12</span>
    <span class="hl com"># exit_price &lt;- 10</span>

    <span class="hl com"># calculate the money made (or lost): both are identical, as quantity for short is</span>
    <span class="hl com"># negative: Selling long: open_price * quantity + (close_price - open_price) * quantity</span>
    <span class="hl com"># Selling short: open_price * quantity - (close_price - open_price) * |quantity|</span>

    <span class="hl com"># for long: how much we have X the price X how many times did the price rise</span>
    <span class="hl std">money</span> <span class="hl kwb">&lt;-</span> <span class="hl kwd">abs</span><span class="hl std">(quantity)</span> <span class="hl opt">*</span> <span class="hl std">enter_price</span> <span class="hl opt">*</span> <span class="hl std">(exit_price</span><span class="hl opt">/</span><span class="hl std">enter_price)</span><span class="hl opt">^</span><span class="hl kwd">sign</span><span class="hl std">(quantity)</span>
    <span class="hl kwd">as.numeric</span><span class="hl std">(money)</span>
<span class="hl std">}</span>


<span class="hl std">estimated_total_money</span> <span class="hl kwb">&lt;-</span> <span class="hl kwa">function</span><span class="hl std">() {</span>
    <span class="hl std">my_assets</span> <span class="hl kwb">&lt;-</span> <span class="hl kwd">my_assets</span><span class="hl std">()</span>
    <span class="hl std">money</span> <span class="hl kwb">&lt;-</span> <span class="hl std">my_assets[</span><span class="hl num">1</span><span class="hl std">]</span>
    <span class="hl kwa">for</span> <span class="hl std">(i</span> <span class="hl kwa">in</span> <span class="hl num">1</span><span class="hl opt">:</span><span class="hl num">5</span><span class="hl std">) money</span> <span class="hl kwb">&lt;-</span> <span class="hl std">money</span> <span class="hl opt">+</span> <span class="hl kwd">price_of_selling_asset</span><span class="hl std">(</span><span class="hl kwd">names</span><span class="hl std">(my_assets)[</span><span class="hl opt">-</span><span class="hl num">1</span><span class="hl std">][i])</span>
    <span class="hl std">money</span>
<span class="hl std">}</span>


<span class="hl com"># actually sell the asset</span>
<span class="hl std">sell_asset</span> <span class="hl kwb">&lt;-</span> <span class="hl kwa">function</span><span class="hl std">(</span><span class="hl kwc">asset_name</span><span class="hl std">) {</span>
    <span class="hl std">money</span> <span class="hl kwb">&lt;-</span> <span class="hl kwd">price_of_selling_asset</span><span class="hl std">(asset_name)</span>

    <span class="hl std">new_my_assets</span> <span class="hl kwb">&lt;-</span> <span class="hl kwd">my_assets</span><span class="hl std">()</span>
    <span class="hl std">new_my_assets[asset_name]</span> <span class="hl kwb">&lt;-</span> <span class="hl num">0</span>
    <span class="hl std">new_my_assets[</span><span class="hl str">&quot;money&quot;</span><span class="hl std">]</span> <span class="hl kwb">&lt;-</span> <span class="hl std">new_my_assets[</span><span class="hl str">&quot;money&quot;</span><span class="hl std">]</span> <span class="hl opt">+</span> <span class="hl std">money</span>
    <span class="hl com"># as.numeric changes the matrix to a vector so that it doesn't breake the assets.</span>

    <span class="hl kwd">update_my_assets</span><span class="hl std">(new_my_assets)</span>

    <span class="hl kwa">NULL</span>
<span class="hl std">}</span>



<span class="hl com">############################################### </span>
<span class="hl com">#' # Create get_data function (for WIDE data)</span>


<span class="hl com"># get_data_wide &lt;- local({</span>
<span class="hl std">get_data</span> <span class="hl kwb">&lt;-</span> <span class="hl kwd">local</span><span class="hl std">({</span>

    <span class="hl std">all_data</span> <span class="hl kwb">&lt;-</span> <span class="hl kwd">readRDS</span><span class="hl std">(</span><span class="hl str">&quot;test.rds&quot;</span><span class="hl std">)</span>
    <span class="hl com"># all_data &lt;- readRDS('all_data_wide.rds') all_data &lt;- all_data[1:100,]</span>
    <span class="hl com"># length(all_data$Date) # 4204424 unique_Date &lt;- unique(all_data$DATE) # this should be the</span>
    <span class="hl com"># same as all_data$DATE !  n_unique_Date &lt;- length(unique_Date) # 949918</span>
    <span class="hl std">n_Date</span> <span class="hl kwb">&lt;-</span> <span class="hl kwd">length</span><span class="hl std">(all_data</span><span class="hl opt">$</span><span class="hl std">DATE)</span>
    <span class="hl com"># we assume the file is sorted and uniqued...</span>

    <span class="hl com"># length(unique_Date) # 949918 min_data &lt;- min(all_data$Date) max_data &lt;-</span>
    <span class="hl com"># max(all_data$Date)</span>
    <span class="hl std">i_date</span> <span class="hl kwb">&lt;-</span> <span class="hl num">0</span>




    <span class="hl kwa">function</span><span class="hl std">() {</span>

        <span class="hl com"># we moved in time!</span>
        <span class="hl std">i_date</span> <span class="hl kwb">&lt;&lt;-</span> <span class="hl std">i_date</span> <span class="hl opt">+</span> <span class="hl num">1</span>


        <span class="hl com"># temp_data_2 &lt;- all_data[i_date, ]</span>
        <span class="hl kwa">if</span> <span class="hl std">(i_date</span> <span class="hl opt">&gt;</span> <span class="hl std">n_Date) {</span>
            <span class="hl kwd">cat</span><span class="hl std">(</span><span class="hl str">&quot;END OF FILE&quot;</span><span class="hl std">)</span>
            <span class="hl kwd">return</span><span class="hl std">(</span><span class="hl kwa">NULL</span><span class="hl std">)</span>
        <span class="hl std">}</span>
        <span class="hl com"># if(nrow(temp_data_2) == 0) {return(NULL)} else</span>

        <span class="hl com"># my_bids(c(10,20,-5,-30,0)) my_bids(c(100,100,100,100,100))</span>
        <span class="hl std">not_na_bids_TF</span> <span class="hl kwb">&lt;-</span> <span class="hl opt">!</span><span class="hl kwd">is.na</span><span class="hl std">(</span><span class="hl kwd">my_bids</span><span class="hl std">())</span>
        <span class="hl std">not_na_bids_TF_names</span> <span class="hl kwb">&lt;-</span> <span class="hl kwd">names</span><span class="hl std">(not_na_bids_TF)[not_na_bids_TF]</span>

        <span class="hl com"># this should ALWAYS be done.  Step 1: update exit (i.e.:open) prices exit prices is the</span>
        <span class="hl com"># open bid for each stock get_data() set current exit price:</span>
        <span class="hl std">current_open_prices</span> <span class="hl kwb">&lt;-</span> <span class="hl kwd">with</span><span class="hl std">(</span><span class="hl kwd">environment</span><span class="hl std">(get_data), {</span>
            <span class="hl com"># ss_col_open &lt;- with(environment(get_data), grepl('open', colnames(all_data) ))</span>
            <span class="hl std">ss_col_open</span> <span class="hl kwb">&lt;-</span> <span class="hl kwd">grepl</span><span class="hl std">(</span><span class="hl str">&quot;open&quot;</span><span class="hl std">,</span> <span class="hl kwd">colnames</span><span class="hl std">(all_data))</span>
            <span class="hl std">opens</span> <span class="hl kwb">&lt;-</span> <span class="hl kwd">as.numeric</span><span class="hl std">(all_data[i_date, ss_col_open])</span>
            <span class="hl kwd">names</span><span class="hl std">(opens)</span> <span class="hl kwb">&lt;-</span> <span class="hl kwd">colnames</span><span class="hl std">(all_data)[ss_col_open]</span>
            <span class="hl std">opens</span>
        <span class="hl std">})</span>
        <span class="hl com"># if some of them are NA, use the previos exit price:</span>
        <span class="hl std">na_current_open_prices</span> <span class="hl kwb">&lt;-</span> <span class="hl kwd">is.na</span><span class="hl std">(current_open_prices)</span>
        <span class="hl std">current_open_prices[na_current_open_prices]</span> <span class="hl kwb">&lt;-</span> <span class="hl kwd">my_assets_exit_price</span><span class="hl std">()[na_current_open_prices]</span>
        <span class="hl kwd">update_my_assets_exit_price</span><span class="hl std">(current_open_prices)</span>
        <span class="hl com"># my_assets_exit_price()</span>



        <span class="hl kwa">if</span> <span class="hl std">(</span><span class="hl kwd">any</span><span class="hl std">(not_na_bids_TF)) {</span>


            <span class="hl com"># my_assets() update_my_assets(c(1000000, 2, 0,0,0,0))</span>

            <span class="hl com"># Step 2: sell all of the non-NA bids</span>
            <span class="hl kwa">for</span> <span class="hl std">(i</span> <span class="hl kwa">in</span> <span class="hl std">not_na_bids_TF_names)</span> <span class="hl kwd">sell_asset</span><span class="hl std">(i)</span>

            <span class="hl com"># Step 3: update enter (i.e.:open for non NA) prices</span>
            <span class="hl std">new_enter_price</span> <span class="hl kwb">&lt;-</span> <span class="hl kwd">my_assets_enter_price</span><span class="hl std">()</span>
            <span class="hl std">new_enter_price[not_na_bids_TF]</span> <span class="hl kwb">&lt;-</span> <span class="hl kwd">my_assets_exit_price</span><span class="hl std">()[not_na_bids_TF]</span>
            <span class="hl kwd">update_my_assets_enter_price</span><span class="hl std">(new_enter_price)</span>

            <span class="hl com"># Step 4: if we do not have enough money - update the bids!</span>
            <span class="hl std">cost_per_asset</span> <span class="hl kwb">&lt;-</span> <span class="hl kwd">my_assets_enter_price</span><span class="hl std">()[not_na_bids_TF]</span> <span class="hl opt">*</span> <span class="hl kwd">abs</span><span class="hl std">(</span><span class="hl kwd">my_bids</span><span class="hl std">())[not_na_bids_TF]</span>
            <span class="hl com"># we use 'abs' on my_bids, in order to allow shorts</span>
            <span class="hl std">total_cost</span> <span class="hl kwb">&lt;-</span> <span class="hl kwd">sum</span><span class="hl std">(cost_per_asset)</span>
            <span class="hl std">my_money</span> <span class="hl kwb">&lt;-</span> <span class="hl kwd">unname</span><span class="hl std">(</span><span class="hl kwd">my_assets</span><span class="hl std">()[</span><span class="hl num">1</span><span class="hl std">])</span>

            <span class="hl kwa">if</span> <span class="hl std">(total_cost</span> <span class="hl opt">&gt;</span> <span class="hl std">my_money) {</span>
                <span class="hl com"># then we need to update the bids so that (total_cost == my_money)</span>
                <span class="hl std">bid_reduction_factor</span> <span class="hl kwb">&lt;-</span> <span class="hl std">my_money</span><span class="hl opt">/</span><span class="hl std">total_cost</span>
                <span class="hl std">new_bids</span> <span class="hl kwb">&lt;-</span> <span class="hl kwd">my_bids</span><span class="hl std">()</span> <span class="hl opt">*</span> <span class="hl std">bid_reduction_factor</span>
                <span class="hl kwd">my_bids</span><span class="hl std">(new_bids)</span>
            <span class="hl std">}</span>

            <span class="hl com"># Step 5: buy the new assets</span>
            <span class="hl std">cost_per_asset</span> <span class="hl kwb">&lt;-</span> <span class="hl kwd">my_assets_enter_price</span><span class="hl std">()[not_na_bids_TF]</span> <span class="hl opt">*</span> <span class="hl kwd">abs</span><span class="hl std">(</span><span class="hl kwd">my_bids</span><span class="hl std">())[not_na_bids_TF]</span>
            <span class="hl com"># we use 'abs' on my_bids, in order to allow shorts</span>
            <span class="hl std">total_cost</span> <span class="hl kwb">&lt;-</span> <span class="hl kwd">sum</span><span class="hl std">(cost_per_asset)</span>
            <span class="hl std">new_money</span> <span class="hl kwb">&lt;-</span> <span class="hl std">my_money</span> <span class="hl opt">-</span> <span class="hl std">total_cost</span>
            <span class="hl std">new_stocks</span> <span class="hl kwb">&lt;-</span> <span class="hl kwd">my_assets</span><span class="hl std">()[</span><span class="hl opt">-</span><span class="hl num">1</span><span class="hl std">]</span>
            <span class="hl std">new_stocks[not_na_bids_TF]</span> <span class="hl kwb">&lt;-</span> <span class="hl std">new_stocks[not_na_bids_TF]</span> <span class="hl opt">+</span> <span class="hl kwd">my_bids</span><span class="hl std">()[not_na_bids_TF]</span>  <span class="hl com"># what our new stocks are\t\t</span>
            <span class="hl kwd">update_my_assets</span><span class="hl std">(</span><span class="hl kwd">c</span><span class="hl std">(new_money, new_stocks))</span>

            <span class="hl com"># Step 6: reset the bids.</span>
            <span class="hl kwd">my_bids</span><span class="hl std">(</span><span class="hl kwd">rep</span><span class="hl std">(</span><span class="hl num">NA</span><span class="hl std">,</span> <span class="hl num">5</span><span class="hl std">))</span>


        <span class="hl std">}</span>



        <span class="hl com"># Step 7: updated exit prices again (this time, based on closes</span>
        <span class="hl std">current_close_prices</span> <span class="hl kwb">&lt;-</span> <span class="hl kwd">with</span><span class="hl std">(</span><span class="hl kwd">environment</span><span class="hl std">(get_data), {</span>
            <span class="hl com"># ss_col_open &lt;- with(environment(get_data), grepl('open', colnames(all_data) ))</span>
            <span class="hl std">ss_col_open</span> <span class="hl kwb">&lt;-</span> <span class="hl kwd">grepl</span><span class="hl std">(</span><span class="hl str">&quot;close&quot;</span><span class="hl std">,</span> <span class="hl kwd">colnames</span><span class="hl std">(all_data))</span>
            <span class="hl std">opens</span> <span class="hl kwb">&lt;-</span> <span class="hl kwd">as.numeric</span><span class="hl std">(all_data[i_date, ss_col_open])</span>
            <span class="hl kwd">names</span><span class="hl std">(opens)</span> <span class="hl kwb">&lt;-</span> <span class="hl kwd">colnames</span><span class="hl std">(all_data)[ss_col_open]</span>
            <span class="hl std">opens</span>
        <span class="hl std">})</span>
        <span class="hl com"># if some of them are NA, use the previos exit price:</span>
        <span class="hl std">na_current_close_prices</span> <span class="hl kwb">&lt;-</span> <span class="hl kwd">is.na</span><span class="hl std">(current_close_prices)</span>
        <span class="hl std">current_close_prices[na_current_close_prices]</span> <span class="hl kwb">&lt;-</span> <span class="hl kwd">my_assets_exit_price</span><span class="hl std">()[na_current_close_prices]</span>
        <span class="hl kwd">update_my_assets_exit_price</span><span class="hl std">(current_close_prices)</span>
        <span class="hl com"># my_assets_exit_price()</span>


        <span class="hl kwd">return</span><span class="hl std">(all_data[i_date, ])</span>
    <span class="hl std">}</span>
<span class="hl std">})</span>

<span class="hl com"># system.time(get_data_wide()) # around 0.02 sec for each run!</span>
<span class="hl com"># install.packages('microbenchmark') require('microbenchmark') #</span>
<span class="hl com"># microbenchmark(get_data_wide()) # around 0.013 sec for each run!  head(all_data)</span>
<span class="hl com"># get_data_wide() for(i in 1:100) print(get_data_wide())</span>


<span class="hl com"># Easily get my data (so far)</span>
<span class="hl std">my_data</span> <span class="hl kwb">&lt;-</span> <span class="hl kwa">function</span><span class="hl std">() {</span>
    <span class="hl std">i_date</span> <span class="hl kwb">&lt;-</span> <span class="hl kwd">with</span><span class="hl std">(</span><span class="hl kwd">environment</span><span class="hl std">(get_data), i_date)</span>
    <span class="hl kwa">if</span> <span class="hl std">(i_date</span> <span class="hl opt">==</span> <span class="hl num">0</span><span class="hl std">)</span>
        <span class="hl kwd">return</span><span class="hl std">(</span><span class="hl kwa">NULL</span><span class="hl std">)</span>
    <span class="hl com"># else:</span>
    <span class="hl kwd">with</span><span class="hl std">(</span><span class="hl kwd">environment</span><span class="hl std">(get_data), all_data[</span><span class="hl num">1</span><span class="hl opt">:</span><span class="hl std">(i_date), ])</span>
<span class="hl std">}</span>



<span class="hl com"># TODO: this one can be made faster by just saving an internal object with the closes and</span>
<span class="hl com"># updating it...  rm(ss_col_close)</span>
<span class="hl std">my_latest_closes</span> <span class="hl kwb">&lt;-</span> <span class="hl kwa">function</span><span class="hl std">() {</span>
    <span class="hl std">i_date</span> <span class="hl kwb">&lt;-</span> <span class="hl kwd">with</span><span class="hl std">(</span><span class="hl kwd">environment</span><span class="hl std">(get_data), i_date)</span>
    <span class="hl kwa">if</span> <span class="hl std">(i_date</span> <span class="hl opt">==</span> <span class="hl num">0</span><span class="hl std">)</span>
        <span class="hl kwd">return</span><span class="hl std">(</span><span class="hl kwa">NULL</span><span class="hl std">)</span>
    <span class="hl com"># else:</span>
    <span class="hl kwd">with</span><span class="hl std">(</span><span class="hl kwd">environment</span><span class="hl std">(get_data), {</span>
        <span class="hl std">ss_col_close</span> <span class="hl kwb">&lt;-</span> <span class="hl kwd">with</span><span class="hl std">(</span><span class="hl kwd">environment</span><span class="hl std">(get_data),</span> <span class="hl kwd">grepl</span><span class="hl std">(</span><span class="hl str">&quot;close&quot;</span><span class="hl std">,</span> <span class="hl kwd">colnames</span><span class="hl std">(all_data)))</span>
        <span class="hl std">get_last_value</span> <span class="hl kwb">&lt;-</span> <span class="hl kwa">function</span><span class="hl std">(</span><span class="hl kwc">x</span><span class="hl std">) {</span>
            <span class="hl kwd">tail</span><span class="hl std">(</span><span class="hl kwd">na.omit</span><span class="hl std">(x),</span> <span class="hl num">1</span><span class="hl std">)</span>
        <span class="hl std">}</span>
        <span class="hl kwd">apply</span><span class="hl std">(all_data[</span><span class="hl num">1</span><span class="hl opt">:</span><span class="hl std">i_date, ss_col_close],</span> <span class="hl num">2</span><span class="hl std">, get_last_value)</span>
    <span class="hl std">})</span>
<span class="hl std">}</span>

<span class="hl com"># my_latest_closes()</span>

<span class="hl com"># get_data_wide() my_data() with(environment(get_data), i_date)</span>


<span class="hl com"># with(environment(get_data), dim(all_data))</span>


<span class="hl com">############ Next functions: set_position get_position</span>





<span class="hl com">############################################### </span>
<span class="hl com">#' # Create get_position function</span>

<span class="hl std">my_assets</span> <span class="hl kwb">&lt;-</span> <span class="hl kwd">local</span><span class="hl std">({</span>
    <span class="hl std">assets_names</span> <span class="hl kwb">&lt;-</span> <span class="hl kwd">c</span><span class="hl std">(</span><span class="hl str">&quot;money&quot;</span><span class="hl std">,</span> <span class="hl str">&quot;German10&quot;</span><span class="hl std">,</span> <span class="hl str">&quot;German5&quot;</span><span class="hl std">,</span> <span class="hl str">&quot;TYc1&quot;</span><span class="hl std">,</span> <span class="hl str">&quot;US5Y&quot;</span><span class="hl std">,</span> <span class="hl str">&quot;EUR_USD&quot;</span><span class="hl std">)</span>
    <span class="hl std">assets</span> <span class="hl kwb">&lt;-</span> <span class="hl kwd">c</span><span class="hl std">(</span><span class="hl num">10</span><span class="hl opt">^</span><span class="hl num">6</span><span class="hl std">,</span> <span class="hl kwd">rep</span><span class="hl std">(</span><span class="hl num">0</span><span class="hl std">,</span> <span class="hl num">5</span><span class="hl std">))</span>
    <span class="hl com"># assets &lt;- rep(10^9, 6) I start with 1 million of everything so to enable 'shorting' a</span>
    <span class="hl com"># stock, without the need to get into managing more complex types of assets.</span>
    <span class="hl kwd">names</span><span class="hl std">(assets)</span> <span class="hl kwb">&lt;-</span> <span class="hl std">assets_names</span>

    <span class="hl kwa">function</span><span class="hl std">() {</span>
        <span class="hl kwd">return</span><span class="hl std">(assets)</span>
    <span class="hl std">}</span>
<span class="hl std">})</span>


<span class="hl std">my_assets_enter_price</span> <span class="hl kwb">&lt;-</span> <span class="hl kwd">local</span><span class="hl std">({</span>
    <span class="hl std">assets_names</span> <span class="hl kwb">&lt;-</span> <span class="hl kwd">c</span><span class="hl std">(</span><span class="hl str">&quot;German10&quot;</span><span class="hl std">,</span> <span class="hl str">&quot;German5&quot;</span><span class="hl std">,</span> <span class="hl str">&quot;TYc1&quot;</span><span class="hl std">,</span> <span class="hl str">&quot;US5Y&quot;</span><span class="hl std">,</span> <span class="hl str">&quot;EUR_USD&quot;</span><span class="hl std">)</span>
    <span class="hl std">assets_enter_price</span> <span class="hl kwb">&lt;-</span> <span class="hl kwd">rep</span><span class="hl std">(</span><span class="hl num">0</span><span class="hl std">,</span> <span class="hl num">5</span><span class="hl std">)</span>
    <span class="hl com"># assets &lt;- rep(10^9, 6) I start with 1 million of everything so to enable 'shorting' a</span>
    <span class="hl com"># stock, without the need to get into managing more complex types of assets.</span>
    <span class="hl kwd">names</span><span class="hl std">(assets_enter_price)</span> <span class="hl kwb">&lt;-</span> <span class="hl std">assets_names</span>

    <span class="hl kwa">function</span><span class="hl std">() {</span>
        <span class="hl kwd">return</span><span class="hl std">(assets_enter_price)</span>
    <span class="hl std">}</span>
<span class="hl std">})</span>

<span class="hl std">my_assets_exit_price</span> <span class="hl kwb">&lt;-</span> <span class="hl kwd">local</span><span class="hl std">({</span>
    <span class="hl std">assets_names</span> <span class="hl kwb">&lt;-</span> <span class="hl kwd">c</span><span class="hl std">(</span><span class="hl str">&quot;German10&quot;</span><span class="hl std">,</span> <span class="hl str">&quot;German5&quot;</span><span class="hl std">,</span> <span class="hl str">&quot;TYc1&quot;</span><span class="hl std">,</span> <span class="hl str">&quot;US5Y&quot;</span><span class="hl std">,</span> <span class="hl str">&quot;EUR_USD&quot;</span><span class="hl std">)</span>
    <span class="hl std">assets_exit_price</span> <span class="hl kwb">&lt;-</span> <span class="hl kwd">rep</span><span class="hl std">(</span><span class="hl num">0</span><span class="hl std">,</span> <span class="hl num">5</span><span class="hl std">)</span>
    <span class="hl com"># assets &lt;- rep(10^9, 6) I start with 1 million of everything so to enable 'shorting' a</span>
    <span class="hl com"># stock, without the need to get into managing more complex types of assets.</span>
    <span class="hl kwd">names</span><span class="hl std">(assets_exit_price)</span> <span class="hl kwb">&lt;-</span> <span class="hl std">assets_names</span>

    <span class="hl kwa">function</span><span class="hl std">() {</span>
        <span class="hl kwd">return</span><span class="hl std">(assets_exit_price)</span>
    <span class="hl std">}</span>
<span class="hl std">})</span>


<span class="hl com"># my_assets_enter_price() my_assets_exit_price()</span>
<span class="hl com"># update_my_assets_enter_price(c(1,1,90,2,2)) my_assets_enter_price()</span>

<span class="hl com"># my_assets()</span>


<span class="hl com">############################################### </span>
<span class="hl com">#' # Create get_position function</span>

<span class="hl com"># an internal function to update assets (should be used by get_data_wide)</span>
<span class="hl std">update_my_assets</span> <span class="hl kwb">&lt;-</span> <span class="hl kwa">function</span><span class="hl std">(</span><span class="hl kwc">new_assets</span><span class="hl std">) {</span>
    <span class="hl kwd">names</span><span class="hl std">(new_assets)</span> <span class="hl kwb">&lt;-</span> <span class="hl kwd">names</span><span class="hl std">(</span><span class="hl kwd">environment</span><span class="hl std">(my_assets)</span><span class="hl opt">$</span><span class="hl std">assets)</span>
    <span class="hl kwd">environment</span><span class="hl std">(my_assets)</span><span class="hl opt">$</span><span class="hl std">assets</span> <span class="hl kwb">&lt;-</span> <span class="hl std">new_assets</span>
    <span class="hl kwd">invisible</span><span class="hl std">(</span><span class="hl kwd">my_assets</span><span class="hl std">())</span>
<span class="hl std">}</span>

<span class="hl std">update_my_assets_enter_price</span> <span class="hl kwb">&lt;-</span> <span class="hl kwa">function</span><span class="hl std">(</span><span class="hl kwc">new_assets_enter_price</span><span class="hl std">) {</span>
    <span class="hl kwd">names</span><span class="hl std">(new_assets_enter_price)</span> <span class="hl kwb">&lt;-</span> <span class="hl kwd">names</span><span class="hl std">(</span><span class="hl kwd">environment</span><span class="hl std">(my_assets_enter_price)</span><span class="hl opt">$</span><span class="hl std">assets_enter_price)</span>
    <span class="hl kwd">environment</span><span class="hl std">(my_assets_enter_price)</span><span class="hl opt">$</span><span class="hl std">assets_enter_price</span> <span class="hl kwb">&lt;-</span> <span class="hl std">new_assets_enter_price</span>
    <span class="hl kwd">invisible</span><span class="hl std">(</span><span class="hl kwd">my_assets_enter_price</span><span class="hl std">())</span>
<span class="hl std">}</span>

<span class="hl std">update_my_assets_exit_price</span> <span class="hl kwb">&lt;-</span> <span class="hl kwa">function</span><span class="hl std">(</span><span class="hl kwc">new_assets_exit_price</span><span class="hl std">) {</span>
    <span class="hl kwd">names</span><span class="hl std">(new_assets_exit_price)</span> <span class="hl kwb">&lt;-</span> <span class="hl kwd">names</span><span class="hl std">(</span><span class="hl kwd">environment</span><span class="hl std">(my_assets_exit_price)</span><span class="hl opt">$</span><span class="hl std">assets_exit_price)</span>
    <span class="hl kwd">environment</span><span class="hl std">(my_assets_exit_price)</span><span class="hl opt">$</span><span class="hl std">assets_exit_price</span> <span class="hl kwb">&lt;-</span> <span class="hl std">new_assets_exit_price</span>
    <span class="hl kwd">invisible</span><span class="hl std">(</span><span class="hl kwd">my_assets_exit_price</span><span class="hl std">())</span>
<span class="hl std">}</span>

<span class="hl com"># my_assets()</span>

<span class="hl com">############################################### </span>
<span class="hl com">#' # Create bid_asset function</span>

<span class="hl com"># + is buying - is selling all transactions go through money!</span>
<span class="hl std">my_bids</span> <span class="hl kwb">&lt;-</span> <span class="hl kwd">local</span><span class="hl std">({</span>
    <span class="hl std">bids_names</span> <span class="hl kwb">&lt;-</span> <span class="hl kwd">c</span><span class="hl std">(</span><span class="hl str">&quot;German10&quot;</span><span class="hl std">,</span> <span class="hl str">&quot;German5&quot;</span><span class="hl std">,</span> <span class="hl str">&quot;TYc1&quot;</span><span class="hl std">,</span> <span class="hl str">&quot;US5Y&quot;</span><span class="hl std">,</span> <span class="hl str">&quot;EUR_USD&quot;</span><span class="hl std">)</span>
    <span class="hl std">bids</span> <span class="hl kwb">&lt;-</span> <span class="hl kwd">rep</span><span class="hl std">(</span><span class="hl num">NA</span><span class="hl std">,</span> <span class="hl num">5</span><span class="hl std">)</span>
    <span class="hl kwd">names</span><span class="hl std">(bids)</span> <span class="hl kwb">&lt;-</span> <span class="hl std">bids_names</span>

    <span class="hl com"># # round to plus minus 100 (vectorized) round_to_pm_100 &lt;- function(x) { x&lt;-</span>
    <span class="hl com"># ifelse(sign(x) == 1 &amp; x&gt;100, 100,x ) x&lt;- ifelse(sign(x) == -1 &amp; x &lt; -100, -100,x ) x } #</span>
    <span class="hl com"># round_to_pm_100(c(-100, -101, 101, 100, 0, 55, -55)) # sign(3) # sign(-3) # sign(0)</span>
    <span class="hl kwa">function</span><span class="hl std">(</span><span class="hl kwc">new_bids</span><span class="hl std">) {</span>
        <span class="hl com"># We can add conditions if the actions are valid...</span>

        <span class="hl com"># if we do not place any bid, then we see what are the current bids...</span>
        <span class="hl kwa">if</span> <span class="hl std">(</span><span class="hl kwd">missing</span><span class="hl std">(new_bids)) {</span>
            <span class="hl kwd">return</span><span class="hl std">(bids)</span>
        <span class="hl std">}</span>

        <span class="hl com"># if bids are not of the correct length</span>
        <span class="hl kwa">if</span> <span class="hl std">(</span><span class="hl kwd">length</span><span class="hl std">(new_bids)</span> <span class="hl opt">!=</span> <span class="hl num">5</span><span class="hl std">) {</span>
            <span class="hl kwd">warning</span><span class="hl std">(</span><span class="hl str">&quot;The length of your bids is not 5, bids were not updated!&quot;</span><span class="hl std">)</span>
            <span class="hl kwd">return</span><span class="hl std">(bids)</span>
        <span class="hl std">}</span>

        <span class="hl com"># if new_bids are missing names, let's put them in.</span>
        <span class="hl kwa">if</span> <span class="hl std">(</span><span class="hl kwd">is.null</span><span class="hl std">(</span><span class="hl kwd">names</span><span class="hl std">(new_bids)))</span>
            <span class="hl kwd">names</span><span class="hl std">(new_bids)</span> <span class="hl kwb">&lt;-</span> <span class="hl std">bids_names</span>

        <span class="hl com"># money &lt;- my_assets()[1] if(money &lt;= 0) { warning('You have no money left, you may only</span>
        <span class="hl com"># sell assets') # Making any positive bids 0: new_bids &lt;- ifelse(new_bids &gt;0, 0, new_bids)</span>
        <span class="hl com"># }</span>

        <span class="hl com"># in any case we ask to sell more than we have - sell all that we have if(any(-new_bids &gt;</span>
        <span class="hl com"># my_assets()[-1])) warning('You made bids which are to sell more than you have. Selling</span>
        <span class="hl com"># all of that asset') new_bids &lt;- ifelse(-new_bids &gt; my_assets()[-1], my_assets()[-1],</span>
        <span class="hl com"># new_bids)</span>

        <span class="hl com"># # Let's force up to 100 units per of action if(any(abs(new_bids) &gt; 100)) { warning('Some</span>
        <span class="hl com"># bids were beyond 100 units - and were rounded to 100 unit distance!') } new_bids &lt;-</span>
        <span class="hl com"># round_to_pm_100(new_bids)</span>

        <span class="hl com"># else, place bids, and returns bids.</span>
        <span class="hl std">bids</span> <span class="hl kwb">&lt;&lt;-</span> <span class="hl std">new_bids</span>
        <span class="hl kwd">return</span><span class="hl std">(bids)</span>
    <span class="hl std">}</span>
<span class="hl std">})</span>

<span class="hl com"># my_assets() my_bids(c(0,0,10000,0,0)) my_bids(c(0,0,100,0,0)) get_data()</span>
<span class="hl com"># my_bids(c(0,10000,0,0,0)) my_bids(c(0,0,-100,0,0)) my_bids(c(0,0,-101,0,0))</span>
<span class="hl com"># my_bids(c(0,0,-1000000000,0,0)) my_bids(c(0,0,-1000000001,0,0))</span>



<span class="hl std">sell_everything</span> <span class="hl kwb">&lt;-</span> <span class="hl kwa">function</span><span class="hl std">() {</span>
    <span class="hl kwd">my_bids</span><span class="hl std">(</span><span class="hl kwd">rep</span><span class="hl std">(</span><span class="hl num">0</span><span class="hl std">,</span> <span class="hl num">5</span><span class="hl std">))</span>
<span class="hl std">}</span>


<span class="hl com"># my_bids() my_bids(c(4,4,4)) my_bids(c(10,-5,0,0,0,0)) my_bids()</span>



<span class="hl com"># TODO: update get_data_wide so it would update the assets based on the bids this logic</span>
<span class="hl com"># needs some more thinking...</span>
</pre></div>
</div></div>


  <p>The R session information (including the OS info, R version and all
    packages used):</p>

<div class="chunk" id="session-info"><div class="rcode"><div class="source"><pre class="knitr r"><span class="hl kwd">sessionInfo</span><span class="hl std">()</span>
</pre></div>
<div class="output"><pre class="knitr r">## R version 3.0.3 (2014-03-06)
## Platform: x86_64-w64-mingw32/x64 (64-bit)
## 
## locale:
## [1] LC_COLLATE=Hebrew_Israel.1255  LC_CTYPE=Hebrew_Israel.1255   
## [3] LC_MONETARY=Hebrew_Israel.1255 LC_NUMERIC=C                  
## [5] LC_TIME=Hebrew_Israel.1255    
## 
## attached base packages:
## [1] stats     graphics  grDevices datasets  utils     methods   base     
## 
## other attached packages:
## [1] knitr_1.5       installr_0.14.2
## 
## loaded via a namespace (and not attached):
## [1] evaluate_0.5.1 formatR_0.10   highr_0.3      stringr_0.6.2  tools_3.0.3
</pre></div>
<div class="source"><pre class="knitr r"><span class="hl kwd">Sys.time</span><span class="hl std">()</span>
</pre></div>
<div class="output"><pre class="knitr r">## [1] "2014-04-21 20:50:06 IDT"
</pre></div>
</div></div>




</body>
</html>
